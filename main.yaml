---
- hosts: localhost
  gather_facts: no

  vars_files:
    - "vars/creds.yaml"

  tasks:
    # - local_action:
    #   - command: ansible-galaxy install avinetworks.aviconfig --roles-path /etc/ansible/roles
    #   - command: ansible-galaxy install avinetworks.avisdk --roles-path /etc/ansible/roles
    - name: Install Avisdk
      command: python2.7 -m pip install avisdk
    # - name: Install avisdk
    #   pip:
    #     name: avisdk
    - name: Avi Deploy new virtual
      include_role:
        name: avinetworks.aviconfig
      vars:
        cloud_name: "Default-Cloud"
        tenant_name: "admin"
        app_name: "{{ ApplicationName }}"
        app_type: "{{ ApplicationType }}"
        env: "{{ Environment }}"
        department: "{{ Department }}"
        avi_controller: "{% if Environment=='aws' %}{{ aws_avi_controller_1 }}{% elif Environment=='ibm-dal'%}{{ ibm_avi_controller_dal }}{% elif Environment=='ibm-lon'%}{{ ibm_avi_controller_lon }}{% endif %}"
        health_monitor: "{{ HealthMonitor }}"
        listening_port: "{{ ListeningPort }}"
        pool_members: "{{  PoolMembers.split('::') }}"
        avi_config_state: "present"
        avi_username: "{{ aws_tower_username }}"
        avi_password: "{{ aws_tower_password }}"
        api_version: "18.2.8"
        aws_subnet: "{{ aws_network_ref }}"
        tmp_avi_config: "{{ lookup('template','template/vs_create.j2') | from_yaml }}"
        avi_config: "{{tmp_avi_config.avi_config }}"